# Нигай Александр БПИ-219

# Отчет по ИДЗ №4

# Вариант 4

## Выполнено на 8 баллов

## Условие задачи
```
Базу данных разделяют два типа про-
цессов – читатели и писатели. Читатели выполняют транзакции, которые
просматривают записи базы данных, транзакции писателей и просматривают
и изменяют записи. Предполагается, что в начале БД находится в непротиво-
речивом состоянии (например, если каждый элемент — число, то они все от-
сортированы). Каждая отдельная транзакция переводит БД из одного непро-
тиворечивого состояния в другое. Для предотвращения взаимного влияния
транзакций процесс-писатель должен иметь исключительный доступ к БД.
Если к БД не обращается ни один из процессов-писателей, то выполнять
транзакции могут одновременно сколько угодно читателей. Создать многопо-
точное приложение с потоками-писателями и потоками-читателями. Реализо-
вать решение, используя семафоры.
```
## Общая информация
Задача решена с помощью семафора и мьютекса.

Исходный код находится в файле *4.c*

Для упрощения модели в качестве базы данных использовался целочисленный массив, состоящий из 10 значений.

На мой взгляд, основная проблема поставленной задачи - это предоставление одновременного доступа нескольким потокам-читателям к БД и при этом ограничение доступа всем потокам, кроме одного писателя, то есть пока происходит запись, все остальные потоки ждут.

Чтобы решить проблему, можно считать количество потоков, одновременно работающих с БД. Изначально счетчик равен нулю. Когда первый поток-читатель начинает работу, он ждет разблокировки семафора, блокирующего запись, а затем сам блокирует его. Остальные потоки-читатели не блокируют семафор, тем самым оставляют процесс чтения из БД не критической секцией, и соответственно, читать одновременно могут несколько потоков. Когда все читатели закончили чтение, семафор записи разблокируется, и БД становится доступной для записи. Так как счетчик потоков-читателей тоже является общим ресурсом, перед его изменением читатели блокируют его мьютексом (можно было использовать и двоичный семафор, но я захотел попробовать оба синхропримитива). С потоками-писателями все попроще - для них достаточно семафора, упомянутого выше. При начале записи семафор блокируется и разблокируется при окончании записи.

Таким образом потоки-писатели работают последовательно, а потоки-читатели выполняются одновременно, если БД не используется писателем.
## Пример работы
Пусть к БД будут отправлены запросы: [запись, чтение, чтение, запись].

Первый писатель заблокирует семафор и начнет запись. Первый читатель заблокирует мьютекс и будет ожидать завершения записи. Как только запись закончится, семафор разблокируется, первый читатель его снова заблокирует, разблокирует мьютекс и тем самым позволит второму читателю выполняться одновременно с ним. Когда оба читателя закончат чтение, они разблокируют семафор, и второй поток-писатель получит доступ к записи в БД.

## Входные данные

Входные представляют из себя список запросов. Запросы могут быть двух типов: 

*    r <*key*> - чтение элемента с индексом *key*
*    w <*key*> <*value*> - изменение значения элемента с индексом *key* на значение *value*

Примеры входных данных находятся в директории *input*.

## Выходные данные
Выходные данные показывают последовательность выполнения потоков.

## Работа с программой

Программу можно запустить со своими входными данными:
```
./4.out <input_file> <output_file>
```
где *input_file* и *output_file* - названия входного и выходного файлов соответственно.

Также программа может сама генерировать входные данные:
```
./4.out -r
```
в таком случае выходные данные будут находиться в *файле random_output.txt*